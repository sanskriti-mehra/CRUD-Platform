<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Mini-IDP Admin</title>
    <link rel="stylesheet" href="/public/styles.css" />
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  </head>
  <body>
    <%- include('includes/navbar') %>
    <div class="container">
      <h1>Mini Internal Developer Platform (Admin)</h1>
      <p>Signed in as: <strong><%= locals.currentUser.name %> (<%= locals.currentUser.role %>)</strong></p>

      <section class="models">
        <h2>Existing Models</h2>
        <% if (models && models.length) { %>
          <ul>
            <% models.forEach(m => { %>
              <li>
                <strong><%= m.name %></strong> â€” table: <%= m.tableName %>
                [ <a href="/listings/<%= m.tableName %>?user=<%= locals.currentUser.username %>">Open list</a> ]
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <p>No models published yet.</p>
        <% } %>
      </section>

      <section class="editor">
        <h2>Define & Publish Model</h2>
        <form action="/admin/publish?user=<%= locals.currentUser.username %>" method="post">
          <div class="row">
            <label>Model Name: <input name="name" required placeholder="e.g., Product" /></label>
            <label>Table name (optional): <input name="tableName" placeholder="e.g., products" /></label>
            <label>Owner field (optional): <input name="ownerField" placeholder="e.g., ownerId" /></label>
          </div>

          <h3>Fields</h3>
          <div id="fields">
            <div class="field-row">
              <input name="field_name[]" placeholder="field name" />
              <select name="field_type[]">
                <option value="string">string</option>
                <option value="number">number</option>
                <option value="boolean">boolean</option>
                <option value="date">date</option>
                <option value="json">json</option>
              </select>
              <label>Required <input type="checkbox" name="field_required[]" /></label>
              <input name="field_default[]" placeholder="default (optional)" />
              <button type="button" onclick="removeField(this)">-</button>
            </div>
          </div>
          <button type="button" onclick="addField()">Add field</button>

          <h3>RBAC (simple)</hAC>
          <p>Default created if left empty: Admin=all, Manager=create|read|update, Viewer=read</p>
          <textarea name="rbac" placeholder='optional JSON for rbac, e.g. {"Admin":["all"]}' rows="4" style="width:100%;"></textarea>

          <div style="margin-top:12px;">
            <button type="submit">Publish Model</button>
          </div>
        </form>
      </section>
    </div>

    <%- include('includes/footer') %>

    <script>
      function addField() {
        const container = document.getElementById('fields');
        const div = document.createElement('div');
        div.className = 'field-row';
        div.innerHTML = `
          <input name="field_name[]" placeholder="field name" />
          <select name="field_type[]">
            <option value="string">string</option>
            <option value="number">number</option>
            <option value="boolean">boolean</option>
            <option value="date">date</option>
            <option value="json">json</option>
          </select>
          <label>Required <input type="checkbox" name="field_required[]" /></label>
          <input name="field_default[]" placeholder="default (optional)" />
          <button type="button" onclick="removeField(this)">-</button>
        `;
        container.appendChild(div);
      }
      function removeField(btn) {
        btn.closest('.field-row').remove();
      }
    </script>
  </body>
</html>
